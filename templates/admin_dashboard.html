<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

{% include "navbar.html" %}

<div class="container mt-4">

    <h2 class="text-center mb-4">Admin Security Dashboard</h2>

    <!-- USERS -->
    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white">Users</div>
        <div class="card-body">
            <table class="table table-striped table-bordered" id="usersTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- ALERT CHART -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning">Alert Severity Overview</div>
        <div class="card-body">
            <canvas id="severityChart"></canvas>
        </div>
    </div>

    <!-- ALERTS -->
    <div class="card shadow">
        <div class="card-header bg-danger text-white">Security Alerts</div>
        <div class="card-body">
            <table class="table table-bordered table-striped" id="alertsTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Severity</th>
                        <th>Message</th>
                        <th>Risk</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch("/api/admin/users")
.then(r=>r.json())
.then(users=>{
    const tbody=document.querySelector("#usersTable tbody");
    users.forEach(u=>{
        const row=document.createElement("tr");
        row.innerHTML=`
            <td>${u.id}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td><a href="/admin/user-profile/${u.id}" class="btn btn-sm btn-primary">View</a></td>
        `;
        tbody.appendChild(row);
    });
});

fetch("/api/admin/alerts")
.then(r=>r.json())
.then(data=>{
    let low=0,medium=0,high=0;
    const tbody=document.querySelector("#alertsTable tbody");

    data.forEach(a=>{
        if(a.severity==="LOW") low++;
        else if(a.severity==="MEDIUM") medium++;
        else high++;

        const row=document.createElement("tr");
        row.innerHTML=`
            <td>${a.id}</td>
            <td>${a.user_id}</td>
            <td class="${a.severity}">${a.severity}</td>
            <td>${a.message}</td>
            <td>${a.risk_score}</td>
            <td>${new Date(a.created_at + "Z").toLocaleString("en-IN",{timeZone:"Asia/Kolkata"})}</td>
        `;
        tbody.appendChild(row);
    });

    new Chart(document.getElementById("severityChart"),{
        type:"bar",
        data:{
            labels:["LOW","MEDIUM","HIGH"],
            datasets:[{label:"Alerts",data:[low,medium,high]}]
        }
    });
});
</script>

</body>
</html>
